{% extends 'admin/base_site.html' %}
{% load i18n admin_urls static jazzmin %}

<!-- Add Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

{% block content %}
<div id="content-main" style="padding: 20px; width: 100%;">
    
    <style>
        /* Styles for alternating table rows */
        #sales-report-table tbody tr:nth-child(odd) {
            background-color: #f9f9f9;
        }

        /* Button styles */
        .btn-pdf, .btn-print {
            padding: 10px 20px;
            background-color: #dc3545;
            color: white !important;
            text-decoration: none !important;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-size: 1em;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-pdf:hover, .btn-print:hover {
            background-color: #c82333;
        }
        
        .btn-pdf i, .btn-pdf a, .btn-print i {
            color: white !important;
            font-size: 16px;
        }
        
        .btn-pdf a {
            color: white !important;
            text-decoration: none !important;
        }

        /* Styles for print view */
        @media print {
            .no-print {
                display: none !important;
            }

            /* Optionally adjust layout for printing */
            body {
                margin: 0;
                padding: 0;
            }

            #content-main {
                padding: 0 !important;
                margin-top: 0 !important;
            }

            /* Ensure tables print correctly */
            table {
                width: 100% !important;
                border-collapse: collapse !important;
            }

            th, td {
                border: 1px solid #ddd !important;
                padding: 8px !important;
            }

            /* Hide footer and branding elements - Added more selectors */
            #footer, .footer, .jazzmin-version, .copyright, footer, [class*="footer"], [id*="footer"], .sidebar-footer {
                display: none !important;
            }
        }
    </style>

    {# Show the form only if orders are NOT present #}
    <div class="no-print">
    {% if not orders %}
    <form method="post" style="margin-bottom: 30px; padding: 25px; border: 1px solid #e0e0e0; border-radius: 8px; background-color: #f9f9f9;">
        {% csrf_token %}
        <div style="display: flex; flex-wrap: wrap; gap: 25px; align-items: flex-end;">
            <div>
                <label for="from_date" style="display: block; margin-bottom: 6px; font-weight: bold;">From Date:</label>
                <input type="date" id="from_date" name="from_date" value="{{ from_date|default:'' }}" style="padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
            </div>
            <div>
                <label for="to_date" style="display: block; margin-bottom: 6px; font-weight: bold;">To Date:</label>
                <input type="date" id="to_date" name="to_date" value="{{ to_date|default:'' }}" style="padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
            </div>
            <div>
                <label for="payment_method" style="display: block; margin-bottom: 6px; font-weight: bold;">Payment Method:</label>
                <select id="payment_method" name="payment_method" style="padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
            <option value="">All</option>
            {% for choice in payment_method_choices %}
                <option value="{{ choice.0 }}" {% if payment_method == choice.0 %}selected{% endif %}>{{ choice.1 }}</option>
            {% endfor %}
        </select>
            </div>
            <button type="submit" style="padding: 10px 20px; background-color: #417690; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1em;">Generate Report</button>
        </div>
    </form>
    {% endif %}
    </div>

    {# Show header and report only if orders are present #}
    {% if orders %}
    {# --- Sales Analytics Header (Mimicking Bill Header) --- #}
    <div style="margin:0 auto 30px auto;padding:20px;border:1px solid #e0e0e0;border-radius:10px;font-family:Arial, sans-serif;background-color:#fff;box-shadow:0 2px 8px rgba(0,0,0,0.05);">
        <div style="display:flex;justify-content:space-between;align-items:center;padding-bottom:15px;border-bottom:1px solid #f0f0f0;">
            <div style="text-align:left;">
                {# Ensure you have a static file at 'images/qr.png' for the logo #}
                <img src="{% static 'images/qr.png' %}" alt="Company Logo" style="max-height: 70px;">
            </div>
            <div style="text-align:right;">
                <h2 style="margin:0;color:#555;font-size:1.5em;">Bhanjyang Village and Lodge</h2>
                <p style="margin:5px 0 0 0;color:#777;font-size:1em;">Sarankot, Pokhara</p>
                <p style="margin:2px 0 0 0;color:#777;font-size:1em;">Contact No: +977-9846852692</p>
            </div>
        </div>
        <div style="text-align:center;margin-top:15px;">
            <h3 style="margin:0;color:#555;font-size:1.3em;">Sales Report {% if from_date and to_date %}( {{ from_date }} to {{ to_date }} ){% endif %}</h3>
            {% if payment_method %}
                <p style="margin:5px 0 0 0;color:#777;font-size:1em;">Payment Method: {{ payment_method }}</p>
            {% endif %}
        </div>
    </div>

    

    <div style="margin-top: 25px; border: 1px solid #e0e0e0; border-radius: 8px; overflow: hidden;">
        <table id="sales-report-table" style="width: 100%; border-collapse: collapse;">
                    <thead>
                <tr style="background-color: #f2f2f2;">
                    <th style="padding: 15px; text-align: left; border-bottom: 1px solid #ddd;">Room No.</th>
                    <th style="padding: 15px; text-align: left; border-bottom: 1px solid #ddd;">Customer Name</th>
                    <th style="padding: 15px; text-align: center; border-bottom: 1px solid #ddd;">Date</th>
                        </tr>
                    </thead>
                    <tbody>
                {% for order in orders %}
                <tr> {# Style moved to CSS block #}
                    <td style="padding: 12px; text-align: left; border-bottom: 1px solid #ddd;">{{ order.room_number }}</td>
                    <td style="padding: 12px; text-align: left; border-bottom: 1px solid #ddd;">{{ order.customer_name }}</td>
                    <td style="padding: 12px; text-align: center; border-bottom: 1px solid #ddd;">{{ order.check_in|date:"Y-m-d" }}</td>
                            </tr>

                <tr>
                    <td colspan="3" style="padding: 0;">
                        <div style="margin: 10px; padding: 10px; border: 1px solid #eee; border-radius: 4px; background-color: #fff;">
                            <h4 style="margin-top: 0; margin-bottom: 8px; font-size: 1em; color: #555;">Ordered Items:</h4>
                            <table style="width: 100%; border-collapse: collapse; margin-bottom: 8px;">
                                <thead>
                                    <tr style="background-color: #f9f9f9;">
                                        <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">Item</th>
                                        <th style="padding: 8px; text-align: center; border-bottom: 1px solid #ddd;">Qty</th>
                                        <th style="padding: 8px; text-align: right; border-bottom: 1px solid #ddd;">Price</th>
                                        <th style="padding: 8px; text-align: right; border-bottom: 1px solid #ddd;">Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in order.items %}
                                    <tr>
                                        <td style="padding: 6px 8px; text-align: left; border-bottom: 1px solid #eee;">{{ item.food.name }}</td>
                                        <td style="padding: 6px 8px; text-align: center; border-bottom: 1px solid #eee;">{{ item.quantity }}</td>
                                        <td style="padding: 6px 8px; text-align: right; border-bottom: 1px solid #eee;">Rs {{ item.price|floatformat:2 }}</td>
                                        <td style="padding: 6px 8px; text-align: right; border-bottom: 1px solid #eee;">Rs {{ item.get_total_price|floatformat:2 }}</td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="4" style="padding: 6px 8px; text-align: center;">No items for this order.</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                            <table style="width: 100%; border-collapse: collapse; margin: 15px 0;">
                                <tr>
                                    <td style="padding: 8px; text-align: left; border: 1px solid #ddd; font-weight: bold;">Order Total</td>
                                    <td style="padding: 8px; text-align: right; border: 1px solid #ddd; font-weight: bold;">Rs {{ order.get_total_cost_of_orders|floatformat:2 }}</td>
                                </tr>
                            </table>
                            <div style="margin-top: 15px;">
                                <table style="width: 100%; border-collapse: collapse; margin-bottom: 10px;">
                                    <tr style="background-color: #f9f9f9;">
                                        <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">Description</th>
                                        <th style="padding: 8px; text-align: right; border: 1px solid #ddd;">Amount</th>
                                    </tr>
                                    <tr>
                                        <td style="padding: 8px; text-align: left; border: 1px solid #ddd;">Room Type</td>
                                        <td style="padding: 8px; text-align: right; border: 1px solid #ddd;">{{ order.category.name }}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 8px; text-align: left; border: 1px solid #ddd;">Days Stayed</td>
                                        <td style="padding: 8px; text-align: right; border: 1px solid #ddd;">{{ order.get_days_stayed }} days</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 8px; text-align: left; border: 1px solid #ddd;">Room Charge</td>
                                        <td style="padding: 8px; text-align: right; border: 1px solid #ddd;">Rs {{ order.get_room_charge|floatformat:2 }}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 8px; text-align: left; border: 1px solid #ddd;">Order Total</td>
                                        <td style="padding: 8px; text-align: right; border: 1px solid #ddd;">Rs {{ order.get_total_cost_of_orders|floatformat:2 }}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 8px; text-align: left; border: 1px solid #ddd; font-weight: bold;">Grand Total</td>
                                        <td style="padding: 8px; text-align: right; border: 1px solid #ddd; font-weight: bold;">Rs {{ order.get_total_bill|floatformat:2 }}</td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </td>
                            </tr>

                        {% empty %}
                            <tr>
                    <td colspan="3" style="padding: 15px; text-align: center;">No sales records found for the selected criteria.</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
    </div>

    {% if total_revenue is not None %}
    <div style="margin-top: 25px; padding: 20px; text-align: right; font-size: 1.3em; font-weight: bold; border-top: 2px solid #417690;">
        Total Revenue: Rs {{ total_revenue|floatformat:2 }}
    </div>

    <div style="margin-top: 20px;">
        <a href="{% url 'admin:restaurant_generate_sales_report_pdf' %}?from_date={{ from_date|urlencode }}&to_date={{ to_date|urlencode }}&payment_method={{ payment_method|urlencode }}" class="btn-pdf">
            <i class="fas fa-file-pdf"></i> Download PDF
        </a>
        <button onclick="printReport()" class="btn-print">
            <i class="fas fa-print"></i> Print Report
        </button>
    </div>
{% endif %}
    {% endif %}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

{# Chart Containers #}
<div class="no-print" style="margin-top: 40px; display: flex; flex-wrap: wrap; gap: 30px;">
    <div style="flex: 1; min-width: 300px; background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
        <h4 style="margin-top: 0; margin-bottom: 15px; text-align: center; color: #555;">Room Occupancy by Category</h4>
        <canvas id="roomOccupancyChart"></canvas>
    </div>

    <div style="flex: 1; min-width: 300px; background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
        <h4 style="margin-top: 0; margin-bottom: 15px; text-align: center; color: #555;">Food Sales by Category</h4>
        <canvas id="foodSalesChart"></canvas>
    </div>
</div>

<div class="no-print" style="margin-top: 30px; background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
    <h4 style="margin-top: 0; margin-bottom: 15px; text-align: center; color: #555;">Monthly Sales Revenue</h4>
    <canvas id="monthlyRevenueChart"></canvas>
</div>

<script>
function printReport() {
            window.print();
}
</script>

<script>
    // Data passed from Django view (parsed from JSON strings)
    const roomOccupancyLabels = JSON.parse('{{ room_occupancy_labels|escapejs }}');
    const roomOccupancyCounts = JSON.parse('{{ room_occupancy_counts|escapejs }}');
    const foodSalesLabels = JSON.parse('{{ food_sales_labels|escapejs }}');
    const foodSalesQuantities = JSON.parse('{{ food_sales_quantities|escapejs }}');
    const monthlyRevenueLabels = JSON.parse('{{ monthly_revenue_labels|escapejs }}');
    const monthlyRevenueValues = JSON.parse('{{ monthly_revenue_values|escapejs }}');

    // --- Room Occupancy Pie Chart ---
    const roomOccupancyCtx = document.getElementById('roomOccupancyChart').getContext('2d');
    new Chart(roomOccupancyCtx, {
        type: 'pie',
        data: {
            labels: roomOccupancyLabels,
            datasets: [{
                label: 'Number of Orders',
                data: roomOccupancyCounts,
                backgroundColor: [
                '#FF0000',  // Standard Red
                '#008000',  // Standard Green
                '#0000FF',  // Standard Blue
                '#FFFF00',  // Standard Yellow
                '#FF00FF',  // Standard Magenta
                '#00FFFF',  // Standard Cyan
                '#f2e3d5',
                '#d8b4a0',
                '#b99c8e',
                '#a77c6b',
            ],
                hoverOffset: 4
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'top',
                },
                title: {
                    display: true,
                    text: 'Room Occupancy by Category'
                }
            }
        },
    });

    // --- Food Sales by Category Pie Chart ---
    const foodSalesCtx = document.getElementById('foodSalesChart').getContext('2d');
    new Chart(foodSalesCtx, {
        type: 'pie',
        data: {
            labels: foodSalesLabels,
            datasets: [{
                label: 'Quantity Sold',
                data: foodSalesQuantities,
                backgroundColor: [
                '#FF0000',  // Standard Red
                '#008000',  // Standard Green
                '#0000FF',  // Standard Blue
                '#FFFF00',  // Standard Yellow
                '#FF00FF',  // Standard Magenta
                '#00FFFF',  // Standard Cyan
                '#f2e3d5',
                '#d8b4a0',
                '#b99c8e',
                '#a77c6b',
            ],
                hoverOffset: 4
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'top',
                },
                title: {
                    display: true,
                    text: 'Food Sales by Category'
                }
            }
        },
    });

    // --- Monthly Sales Revenue Bar Chart ---
    const monthlyRevenueCtx = document.getElementById('monthlyRevenueChart').getContext('2d');
    new Chart(monthlyRevenueCtx, {
        type: 'bar',
        data: {
            labels: monthlyRevenueLabels,
            datasets: [{
                label: 'Revenue (Rs)',
                data: monthlyRevenueValues,
                backgroundColor: '#FF0000',
                borderColor: '#FF0000',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false
                },
                title: {
                    display: true,
                    text: 'Monthly Sales Revenue'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Revenue (Rs)'
                    }
                },
                x: {
                     title: {
                        display: true,
                        text: 'Month'
                    }
                }
            }
        },
    });

</script>

</div>
{% endblock %}